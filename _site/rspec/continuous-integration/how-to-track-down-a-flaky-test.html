<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/Article">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><title>'Flaky' Tests: A Short Story - The Lean Software Boutique</title><meta name="description" content="One of the hardest failing tests to debug are those which fail randomly, alsoknown as &quot;flaky&quot; tests. You write your test cases, you run t..." />
    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Schema.org markup for Google+ -->
    <meta itemprop="name" content="'Flaky' Tests: A Short Story - The Lean Software Boutique">
    <meta itemprop="description" content="One of the hardest failing tests to debug are those which fail randomly, also known as &quot;flaky&quot; tests. You write your test cases, you run ...">
    <!-- meta itemprop="image" content="http://www.example.com/image.jpg" -->

    <!-- Twitter Card data -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@OmbuLabs">

    <meta name="twitter:title" content="'Flaky' Tests: A Short Story - The Lean Software Boutique">
    <meta name="twitter:description" content="One of the hardest failing tests to debug are those which fail randomly, also known as &quot;flaky&quot; tests. You write your test cases, you run ...">
    <meta name="twitter:creator" content="@OmbuLabs">
    <!-- Twitter summary card with large image must be at least 280x150px -->
    <!-- meta name="twitter:image:src" content="http://www.example.com/image.html" -->

    <!-- Open Graph data -->
    <meta property="og:title" content="'Flaky' Tests: A Short Story - The Lean Software Boutique" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://www.ombulabs.com/blog/rspec/continuous-integration/how-to-track-down-a-flaky-test.html" />
    <meta property="og:image" content="https://www.ombulabs.com/assets/isotype.png" />
    <meta property="og:description" content="One of the hardest failing tests to debug are those which fail randomly, also known as &quot;flaky&quot; tests. You write your test cases, you run the tests in your environment (in random order), and see them all pass. Afterwards, you push your code, your CI server runs them and one..." />
    <meta property="og:site_name" content="'Flaky' tests: a short story by @mauro_oto" /><meta property="article:published_time" content="2017-05-04 07:02:00 -0400" />
      <meta property="article:modified_time" content="2017-05-04 07:02:00 -0400" />
      <meta property="article:section" content="One of the hardest failing tests to debug are those which fail randomly, also known as &quot;flaky&quot; tests. You write your test cases, you run the tests in your environment (in random order), and see them all pass. Afterwards, you push your code, your CI server runs them and one..." />
      <meta property="article:tag" content="'Flaky' Tests: A Short Story - The Lean Software Boutique" /><meta property="fb:admins" content="10153304864537860" />

    <link rel="stylesheet" type="text/css" href="/blog/assets/css/screen.css" />
    <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,900,300italic,400italic,700italic|Maven+Pro" rel="stylesheet" type="text/css">
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="/blog/assets/css/main.css" />
    <link rel="stylesheet" type="text/css" href="/assets/ombu_blog/application.css" />
</head>
<body class="home-template">
  <header class="main-header no-cover">
      <nav class="main-nav overlay clearfix"><a class="back-button icon-arrow-left"
                 href="/blog">Home</a>
          <a class="subscribe-button icon-feed" href="/blog/rss.xml">Subscribe</a>
      </nav>
      <div class="vertical">
          <div class="main-header-content inner">
              <h1 class="page-title logo"><a href="/blog">OmbuLabs Blog</a></h1>
              <h2 class="page-description slogan">The Lean Software Boutique</h2>
          </div>
      </div>
      <a class="scroll-down icon-arrow-left" href="#content" data-offset="-45"><span class="hidden">Scroll Down</span></a>
  </header>
    <div id="wrapper">
      <main class="content post-layout" role="main">

    <article class="post">

        <header class="post-header">
            <h1 class="post-title">'Flaky' tests: a short story</h1>
            <section class="post-meta"><img class="author-thumb" src="//2.gravatar.com/avatar/350875eb8fce8553e12040c5a1f5d5d0?s=50" alt="Mauro Otonelli" nopin="nopin" /><a href="/blog/authors/mauro-oto"
     title="Articles by Mauro Otonelli">
     Mauro Otonelli
  </a>on
    
      <a href="/blog/tags/rspec"
         title="Articles about Rspec">Rspec</a>,
      <a href="/blog/tags/continuous-integration"
         title="Articles about Continuous Integration">Continuous Integration</a><time class="post-date" datetime="2017-05-04">
  04 May 2017
</time>
</section>
        </header>

        <section class="post-content">
          <p>One of the hardest failing tests to debug are those which fail randomly, also
known as <strong>&quot;flaky&quot;</strong> tests. You write your test cases, you run the tests in your
environment (in random order), and see them all pass. Afterwards, you push your
code, your CI server runs them and <em>one test fails</em>.</p>

<p>This is not an uncommon scenario, and one <em>too common</em> when using integration
tests which use JS, with <code>Capybara-Webkit</code> or <code>Selenium</code>.
But if your failing test doesn&#39;t communicate with an external API, doesn&#39;t use
JS, and passes locally, it can be a bit nerve-wracking.</p>

<p>After you have identified the failing test, and it still passes after running it
locally, one way to figure out <strong>why</strong> it&#39;s failing is running its context
multiple times.</p>

<p>To automate this process a bit, I like to use the following command:</p>

<!--more-->

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span><span class="k">for</span> i in <span class="o">{</span><span class="m">1</span>..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span> rspec spec/controllers/v7/users_controller_spec.rb:205<span class="p">;</span> <span class="k">done</span>
</code></pre></div>

<p>It will run your test 10 times in a row, and <em>hopefully</em> you might see the
test fail once or twice. RSpec&#39;s feedback should provide some insight into why
the failure occurred. Otherwise, what I like to do before running the command is
add <code>puts</code> statements before the expectations.</p>

<p>If your expectation is:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
</code></pre></div>

<p>a good thing to do would be to change that to:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="nb">puts</span> <span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">80</span>
<span class="nb">puts</span> <span class="s2">&quot;actual response: </span><span class="si">#{</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">puts</span> <span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">80</span>
<span class="nb">puts</span> <span class="s2">&quot;expected response: </span><span class="si">#{</span><span class="n">json</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
</code></pre></div>

<p>(See also: <a href="https://tenderlovemaking.com/2016/02/05/i-am-a-puts-debuggerer.html">I am a puts debuggerer</a>)</p>

<p>Now when your test fails, you&#39;ll be able to see what the contents of the
compared variables were.</p>

<p>In my case, the last time I faced this (which prompted me to write this article),
the test did not fail locally, <em>even after 20 runs</em>. I went back into the CI server,
and noticed the tests&#39; order <em>was not randomized</em>.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span><span class="k">for</span> i in <span class="o">{</span><span class="m">1</span>..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span> rspec spec/controllers/v7/users_controller_spec.rb:205 --order defined<span class="p">;</span> <span class="k">done</span>
</code></pre></div>

<p>By adding <code>--order defined</code> I was able to track down the flaky test and fix it.
On one hand, it&#39;s good the CI caught it because the build is always randomized in
my environment, and one day the test suite would &quot;randomly&quot; be in order and fail.
On the other, this made me realize that I needed to update my <code>yml</code> config for
the CI server to <em>randomize the tests</em> by explicitly using <code>--order random</code>.</p>

<p>The <code>--seed 1234</code> option also exists in RSpec, so if your tests in the CI already use
random ordering and you get a flaky test, you can run:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>rspec spec/controllers/v7/users_controller_spec.rb:205 --seed <span class="m">1234</span>
</code></pre></div>

<p>and it will use the seed provided by you, obtained from the failing
test log on the CI server.</p>

<p>Re-running failing tests has been brought up in the <a href="https://github.com/rspec/rspec-core">RSpec repo</a>
<a href="https://github.com/rspec/rspec-core/issues/456">a couple</a>
<a href="https://github.com/rspec/rspec-core/issues/795">of times</a> in the past.
Some alternatives like <a href="https://github.com/oggy/respec">respec</a> exist, but it
might not be worth it to add to a project as it&#39;s not something that happens too
often.</p>

<p>Depending on your CI server, you may also be able to configure re-runs
using your <code>yml</code> config file, in case your flaky tests are persistent. We have
been using <a href="https://ci.solanolabs.com">Solano CI</a> for a while and by using:</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="l l-Scalar l-Scalar-Plain">rerun_list</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">spec/benchmarks/controllers/v7/users_controller_spec.rb</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
</code></pre></div>

<p>the test runs at least two more times if it fails on the first run, to ensure
that the entire build doesn&#39;t fail because of <em>that one pesky</em> test.</p>

        </section><footer class="post-footer"><figure class="author-image"><a class="img" href="" style="background-image: url(//2.gravatar.com/avatar/350875eb8fce8553e12040c5a1f5d5d0?s=50)">
                <span class="hidden">Mauro Otonelli's Picture</span></a></figure>
            <section class="author">
              <h4> Mauro Otonelli </h4>
              <p>
                We are the Lean Software Boutique. Check us out at <a href="https://www.ombulabs.com">www.ombulabs.com</a>
              </p>
            </section><!-- Share links section --><section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" href="http://twitter.com/share?text='Flaky' tests: a short story&amp;url=https://www.ombulabs.com/blog/rspec/continuous-integration/how-to-track-down-a-flaky-test.html"
        onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.ombulabs.com/blog/rspec/continuous-integration/how-to-track-down-a-flaky-test.html"
        onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=https://www.ombulabs.com/blog/rspec/continuous-integration/how-to-track-down-a-flaky-test.html"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>
<!-- Disqus comments --><section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">

        var disqus_shortname = 'ombulabs';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>
</footer>

    </article><footer class="site-footer clearfix">
  <section class="copyright">
    <figure>
      <img src="/blog/assets/images/creative-commons.png"
           alt="Creative Commons Attribution-NonCommercial">
      <figcaption>
        <a href="http://creativecommons.org/licenses/by-nc/3.0/"
           target="_blank"
           title="Creative Commons Attribution-NonCommercial">Creative Commons Attribution-NonCommercial</a>
      </figcaption>
    </figure>
  </section>
  <section class="poweredby">Made with love using <a href="https://github.com/jekyll/jekyll" target="_blank">Jekyll</a> and
    <a target="_blank" href="http://github.com/rosario/kasper">Kasper theme</a>
  </section>
</footer>
</main>
<div id="sidebar">
  <h2 class="category-name">Listing all tags</h2><h3 class="tag-name">
          <a href="/blog/tags/"
             title="Articles about "></a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/agile"
             title="Articles about Agile">Agile</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/aws"
             title="Articles about Aws">Aws</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/backbone"
             title="Articles about Backbone">Backbone</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/benchmark"
             title="Articles about Benchmark">Benchmark</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/best-practices"
             title="Articles about Best Practices">Best Practices</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/bugs"
             title="Articles about Bugs">Bugs</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/carrierwave"
             title="Articles about Carrierwave">Carrierwave</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/case-study"
             title="Articles about Case Study">Case Study</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/circle-ci"
             title="Articles about Circle Ci">Circle Ci</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/continuous-integration"
             title="Articles about Continuous Integration">Continuous Integration</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/conventions"
             title="Articles about Conventions">Conventions</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/crowdsourcing"
             title="Articles about Crowdsourcing">Crowdsourcing</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/design"
             title="Articles about Design">Design</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/docker"
             title="Articles about Docker">Docker</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/dry"
             title="Articles about Dry">Dry</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/git"
             title="Articles about Git">Git</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/github"
             title="Articles about Github">Github</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/hubot"
             title="Articles about Hubot">Hubot</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/imap"
             title="Articles about Imap">Imap</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/jobs"
             title="Articles about Jobs">Jobs</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/lean-startup"
             title="Articles about Lean Startup">Lean Startup</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/learning"
             title="Articles about Learning">Learning</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/linux"
             title="Articles about Linux">Linux</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/maintenance"
             title="Articles about Maintenance">Maintenance</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/monit"
             title="Articles about Monit">Monit</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/mvp"
             title="Articles about Mvp">Mvp</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/open-source"
             title="Articles about Open Source">Open Source</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/pair-programming"
             title="Articles about Pair Programming">Pair Programming</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/performance"
             title="Articles about Performance">Performance</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/protractor"
             title="Articles about Protractor">Protractor</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/rails"
             title="Articles about Rails">Rails</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/react"
             title="Articles about React">React</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/rspec"
             title="Articles about Rspec">Rspec</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/ruby"
             title="Articles about Ruby">Ruby</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/rubygems"
             title="Articles about Rubygems">Rubygems</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/s3"
             title="Articles about S3">S3</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/security"
             title="Articles about Security">Security</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/sessions"
             title="Articles about Sessions">Sessions</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/slack"
             title="Articles about Slack">Slack</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/software-development"
             title="Articles about Software Development">Software Development</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/software-quality"
             title="Articles about Software Quality">Software Quality</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/team"
             title="Articles about Team">Team</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/upgrades"
             title="Articles about Upgrades">Upgrades</a>
        </h3></div>
</div>

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.1.0/jquery.fitvids.min.js"></script>
    <script type="text/javascript" src="/blog/assets/js/index.js"></script>

    <!-- Google Analytics Tracking code -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-17795190-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
</body>
</html>
