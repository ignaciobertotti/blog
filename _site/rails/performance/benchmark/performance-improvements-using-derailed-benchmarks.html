<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/Article">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><title>OmbuCast Episode 1 - Performance Improvements Using Derailed_benchmarks - The Lean Software Boutique</title><meta name="description" content="Transcript:Hello and welcome to the first OmbuCast by Ombu Labs. In this screencast we&#39;llbe taking a look at thederailed_benchmarks gem,and how..." />
    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Schema.org markup for Google+ -->
    <meta itemprop="name" content="OmbuCast Episode 1 - Performance Improvements Using Derailed_benchmarks - The Lean Software Boutique">
    <meta itemprop="description" content="Transcript:Hello and welcome to the first OmbuCast by Ombu Labs. In this screencast we&#39;llbe taking a look at thederailed_benchmarks gem,and how...">
    <!-- meta itemprop="image" content="http://www.example.com/image.jpg" -->

    <!-- Twitter Card data -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@OmbuLabs">

    <meta name="twitter:title" content="OmbuCast Episode 1 - Performance Improvements Using Derailed_benchmarks - The Lean Software Boutique">
    <meta name="twitter:description" content="Transcript:Hello and welcome to the first OmbuCast by Ombu Labs. In this screencast we&#39;llbe taking a look at thederailed_benchmarks gem,and how...">
    <meta name="twitter:creator" content="@OmbuLabs">
    <!-- Twitter summary card with large image must be at least 280x150px -->
    <!-- meta name="twitter:image:src" content="http://www.example.com/image.html" -->

    <!-- Open Graph data -->
    <meta property="og:title" content="OmbuCast Episode 1 - Performance Improvements Using Derailed_benchmarks - The Lean Software Boutique" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://www.ombulabs.com/blog/rails/performance/benchmark/performance-improvements-using-derailed-benchmarks.html" />
    <meta property="og:image" content="https://www.ombulabs.com/assets/isotype.png" />
    <meta property="og:description" content="Transcript:Hello and welcome to the first OmbuCast by Ombu Labs. In this screencast we&#39;llbe taking a look at thederailed_benchmarks gem,and how you can use it to benchmark your Rails application and find, andhopefully fix bottlenecks in your code." />
    <meta property="og:site_name" content="OmbuCast Episode 1 - Performance improvements using derailed_benchmarks by @mauro_oto" /><meta property="article:published_time" content="2018-07-23 07:48:00 -0400" />
      <meta property="article:modified_time" content="2018-07-23 07:48:00 -0400" />
      <meta property="article:section" content="Transcript:Hello and welcome to the first OmbuCast by Ombu Labs. In this screencast we&#39;llbe taking a look at thederailed_benchmarks gem,and how you can use it to benchmark your Rails application and find, andhopefully fix bottlenecks in your code." />
      <meta property="article:tag" content="OmbuCast Episode 1 - Performance Improvements Using Derailed_benchmarks - The Lean Software Boutique" /><meta property="fb:admins" content="10153304864537860" />

    <link rel="stylesheet" type="text/css" href="/blog/assets/css/screen.css" />
    <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,900,300italic,400italic,700italic|Maven+Pro" rel="stylesheet" type="text/css">
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="/blog/assets/css/main.css" />
    <link rel="stylesheet" type="text/css" href="/assets/ombu_blog/application.css" />
</head>
<body class="home-template">
  <header class="main-header no-cover">
      <nav class="main-nav overlay clearfix"><a class="back-button icon-arrow-left"
                 href="/blog">Home</a>
          <a class="subscribe-button icon-feed" href="/blog/rss.xml">Subscribe</a>
      </nav>
      <div class="vertical">
          <div class="main-header-content inner">
              <h1 class="page-title logo"><a href="/blog">OmbuLabs Blog</a></h1>
              <h2 class="page-description slogan">The Lean Software Boutique</h2>
          </div>
      </div>
      <a class="scroll-down icon-arrow-left" href="#content" data-offset="-45"><span class="hidden">Scroll Down</span></a>
  </header>
    <div id="wrapper">
      <main class="content post-layout" role="main">

    <article class="post">

        <header class="post-header">
            <h1 class="post-title">OmbuCast Episode 1 - Performance improvements using derailed_benchmarks</h1>
            <section class="post-meta"><img class="author-thumb" src="//2.gravatar.com/avatar/350875eb8fce8553e12040c5a1f5d5d0?s=50" alt="Mauro Otonelli" nopin="nopin" /><a href="/blog/authors/mauro-oto"
     title="Articles by Mauro Otonelli">
     Mauro Otonelli
  </a>on
    
      <a href="/blog/tags/rails"
         title="Articles about Rails">Rails</a>,
      <a href="/blog/tags/performance"
         title="Articles about Performance">Performance</a>,
      <a href="/blog/tags/benchmark"
         title="Articles about Benchmark">Benchmark</a><time class="post-date" datetime="2018-07-23">
  23 Jul 2018
</time>
</section>
        </header>

        <section class="post-content">
          <iframe width="560" height="315" src="https://www.youtube.com/embed/Zk67l-ZS9aM" frameborder="0" allowfullscreen></iframe>

<p><strong>Transcript:</strong></p>

<p>Hello and welcome to the first OmbuCast by Ombu Labs. In this screencast we&#39;ll
be taking a look at the
<a href="https://github.com/schneems/derailed_benchmarks"><code>derailed_benchmarks</code></a> gem,
and how you can use it to benchmark your Rails application and find, and
hopefully fix bottlenecks in your code.</p>

<!--more-->

<p>There are two ways you can benchmark your application, one is statically, which
uses your <code>Gemfile</code> to check for any gems which might be too big - which take
too much memory - and the other one is dynamically. To be able to run these,
you&#39;ll need to be able to boot your Rails application in production mode
locally. To be able to run the benchmarks I&#39;ll be showing, you&#39;ll need both the
<code>derailed_benchmarks</code> gem and also the
<a href="https://github.com/tmm1/stackprof"><code>stackprof</code></a> gem.</p>

<p>To show how the gem works, I created a test application, which just returns an
array - a JSON - which has many users, and it&#39;s a Rails 5.2 app. So it probably
won&#39;t be similar to results you may get from your own applications, but it&#39;s
good enough for, just showing how to apply these techniques.</p>

<p>So the first thing that you should do is finding out which one of your endpoints
is slow, be it in production or in development (usually you&#39;ll want to optimize
your production endpoints). And when you do that, you will need to measure how
many iterations per second the endpoint can do. This is to get a baseline, an
idea of how many, or, how fast, your endpoint initially is, and then when you
optimize, you can measure if the optimization was good or not. So our first step
then would be to run the IPS task that <code>derailed_benchmarks</code> provides and
specify that our path to hit will be <code>/users.json</code>.</p>

<p><code>PATH_TO_HIT=/users.json bundle exec derailed exec perf:ips</code></p>

<p>So we run this task and it will give us a number, which is the
IPS, the iterations per second, in this case it&#39;s 263. And this is the starting
point, so any modifications that we do to the code should not make it fall under
263 iterations per second for this endpoint in particular. So to start
optimizing, one thing we can do is to run the <code>stackprof</code> task that
<code>derailed_benchmarks</code> provides, to find where there are any potential
bottlenecks.</p>

<p><code>PATH_TO_HIT=/users.json bundle exec derailed exec perf:stackprof</code></p>

<p>Like before, we specify the <code>/users.json</code> endpoint, and run the
<code>stackprof</code> task. And we get this output from <code>stackprof</code>. The methods on top
are the ones that took the most CPU time: the logger, garbage collection. And
then there&#39;s one that probably jumps out, which is <code>Time.parse</code>, which we&#39;re
using in our controller here, and it&#39;s not exactly a very time consuming task to
parse the time, but since it&#39;s hard-coded, we can use <code>Time.at</code>, which is
slightly more performant than <code>Time.parse</code>, and it will accomplish the same
result. So what we can do here is to check in a Rails console.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="mi">2</span><span class="o">.</span><span class="mi">4</span><span class="o">.</span><span class="mi">2</span> <span class="p">:</span><span class="mo">001</span> <span class="o">&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;2018-02-12 12:00:00 UTC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_i</span>
 <span class="o">=&gt;</span> <span class="mi">1518436800</span>
</code></pre></div>

<p>We can cast to integer, and we get the time that we can use for passing to
<code>Time.at</code>, and then we should do the same for the second one.</p>

<p>If you apply this kind of refactor in a real application, note that these should
probably be constants and not just magic numbers. So now we can run the
<code>stackprof</code> task again, and, yeah, <code>Time.parse</code> should now be gone. This doesn&#39;t
necessarily mean that your iterations per second will be better, it&#39;s a good
indicator, but you still need to double check. So we can check our IPS again,
and, they&#39;re roughly the same as before, which makes sense since it&#39;s a very
small modification, and also a very small app. What we can try and do is make
other changes to our app, and one such change can be the optimization of this
code here.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;send_reminder_at &gt; ?&quot;</span><span class="p">,</span> <span class="n">hour_12</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
  <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="ss">email</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="ss">full_name</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">full_name</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div>

<p>This is actually instantiating one user per iteration, so for each user, we have
to instantiate one object - one user object. So to save memory, we can introduce
a gem, it&#39;s called <code>pluck_to_hash</code>. It acts like ActiveRecord&#39;s <code>pluck</code>, but it
produces a hash like the JSON we&#39;re trying to produce. So let&#39;s try to install
it, and see how our iterations per second change, if they change.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">users_scope</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;send_reminder_at &gt; ?&quot;</span><span class="p">,</span> <span class="n">hour_12</span><span class="p">)</span>
                  <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;created_at &lt; ?&quot;</span><span class="p">,</span> <span class="n">cut_off_date</span><span class="p">)</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">users_scope</span><span class="o">.</span><span class="n">pluck_to_hash</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:full_name</span><span class="p">)</span>
</code></pre></div>

<p>And now we can run our IPS task again, and measure the change. And yeah,
that&#39;s a noticeable difference, there&#39;s about 60 more iterations per second.
Like I mentioned before though, this is a small scale application, so you may
have similar results, or you may not, it depends on your application. Since our
Rails application is serving a JSON, another gem we can use is called
<a href="https://github.com/ohler55/oj"><code>OJ</code></a>. It stands for &quot;optimized JSON&quot;, and it&#39;s
a faster JSON parser than the default that Rails uses. We&#39;ll install it in our
app by adding it to the <code>Gemfile</code>. And then we need to create an initializer,
and we can check our updated IPS.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="c1"># config/initializers/oj.rb</span>

<span class="no">Oj</span><span class="o">.</span><span class="n">optimize_rails</span>
</code></pre></div>

<p>And that&#39;s another performance improvement there, it almost - 400 iterations per
second from 320 and 270 before that, that&#39;s almost 100%, you should keep in mind
though that all of these improvements should be done with a good test suite,
since you should make sure that these changes don&#39;t break compatibility with
your current application. And again, these modifications probably don&#39;t make
much sense in an application this small, but hopefully you can apply them to
your larger Rails applications.</p>

<p>And on a final note, you should benchmark, improve, rinse and repeat. I hope you
found these techniques useful, let me know in the comments if you have doubts
about any of them, and I will see you on the next episode.</p>

        </section><footer class="post-footer"><figure class="author-image"><a class="img" href="" style="background-image: url(//2.gravatar.com/avatar/350875eb8fce8553e12040c5a1f5d5d0?s=50)">
                <span class="hidden">Mauro Otonelli's Picture</span></a></figure>
            <section class="author">
              <h4> Mauro Otonelli </h4>
              <p>
                We are the Lean Software Boutique. Check us out at <a href="https://www.ombulabs.com">www.ombulabs.com</a>
              </p>
            </section><!-- Share links section --><section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" href="http://twitter.com/share?text=OmbuCast Episode 1 - Performance improvements using derailed_benchmarks&amp;url=https://www.ombulabs.com/blog/rails/performance/benchmark/performance-improvements-using-derailed-benchmarks.html"
        onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://www.ombulabs.com/blog/rails/performance/benchmark/performance-improvements-using-derailed-benchmarks.html"
        onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=https://www.ombulabs.com/blog/rails/performance/benchmark/performance-improvements-using-derailed-benchmarks.html"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>
<!-- Disqus comments --><section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">

        var disqus_shortname = 'ombulabs';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>
</footer>

    </article><footer class="site-footer clearfix">
  <section class="copyright">
    <figure>
      <img src="/blog/assets/images/creative-commons.png"
           alt="Creative Commons Attribution-NonCommercial">
      <figcaption>
        <a href="http://creativecommons.org/licenses/by-nc/3.0/"
           target="_blank"
           title="Creative Commons Attribution-NonCommercial">Creative Commons Attribution-NonCommercial</a>
      </figcaption>
    </figure>
  </section>
  <section class="poweredby">Made with love using <a href="https://github.com/jekyll/jekyll" target="_blank">Jekyll</a> and
    <a target="_blank" href="http://github.com/rosario/kasper">Kasper theme</a>
  </section>
</footer>
</main>
<div id="sidebar">
  <h2 class="category-name">Listing all tags</h2><h3 class="tag-name">
          <a href="/blog/tags/"
             title="Articles about "></a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/agile"
             title="Articles about Agile">Agile</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/aws"
             title="Articles about Aws">Aws</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/backbone"
             title="Articles about Backbone">Backbone</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/benchmark"
             title="Articles about Benchmark">Benchmark</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/best-practices"
             title="Articles about Best Practices">Best Practices</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/bugs"
             title="Articles about Bugs">Bugs</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/carrierwave"
             title="Articles about Carrierwave">Carrierwave</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/case-study"
             title="Articles about Case Study">Case Study</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/circle-ci"
             title="Articles about Circle Ci">Circle Ci</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/code-refactor"
             title="Articles about Code Refactor">Code Refactor</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/continuous-integration"
             title="Articles about Continuous Integration">Continuous Integration</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/conventions"
             title="Articles about Conventions">Conventions</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/crowdsourcing"
             title="Articles about Crowdsourcing">Crowdsourcing</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/design"
             title="Articles about Design">Design</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/docker"
             title="Articles about Docker">Docker</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/dry"
             title="Articles about Dry">Dry</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/git"
             title="Articles about Git">Git</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/github"
             title="Articles about Github">Github</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/hubot"
             title="Articles about Hubot">Hubot</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/imap"
             title="Articles about Imap">Imap</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/jobs"
             title="Articles about Jobs">Jobs</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/lean-startup"
             title="Articles about Lean Startup">Lean Startup</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/learning"
             title="Articles about Learning">Learning</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/linux"
             title="Articles about Linux">Linux</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/maintenance"
             title="Articles about Maintenance">Maintenance</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/monit"
             title="Articles about Monit">Monit</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/mvp"
             title="Articles about Mvp">Mvp</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/open-source"
             title="Articles about Open Source">Open Source</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/pair-programming"
             title="Articles about Pair Programming">Pair Programming</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/performance"
             title="Articles about Performance">Performance</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/protractor"
             title="Articles about Protractor">Protractor</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/rails"
             title="Articles about Rails">Rails</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/react"
             title="Articles about React">React</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/rspec"
             title="Articles about Rspec">Rspec</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/ruby"
             title="Articles about Ruby">Ruby</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/rubygems"
             title="Articles about Rubygems">Rubygems</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/s3"
             title="Articles about S3">S3</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/security"
             title="Articles about Security">Security</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/sessions"
             title="Articles about Sessions">Sessions</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/slack"
             title="Articles about Slack">Slack</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/software-development"
             title="Articles about Software Development">Software Development</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/software-quality"
             title="Articles about Software Quality">Software Quality</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/team"
             title="Articles about Team">Team</a>
        </h3><h3 class="tag-name">
          <a href="/blog/tags/upgrades"
             title="Articles about Upgrades">Upgrades</a>
        </h3></div>
</div>

    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.1.0/jquery.fitvids.min.js"></script>
    <script type="text/javascript" src="/blog/assets/js/index.js"></script>

    <!-- Google Analytics Tracking code -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-17795190-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
</body>
</html>
